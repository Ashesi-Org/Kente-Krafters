<?php
session_start();
require_once('db_connection.php');

// Include PayPal SDK or REST API configuration
// Replace these placeholders with your actual PayPal credentials
$paypal_client_id = 'your_paypal_client_id';
$paypal_secret = 'your_paypal_secret';
$paypal_sandbox = true; // Set to false for production

if ($paypal_sandbox) {
    $paypal_url = 'https://api.sandbox.paypal.com/v2/checkout/orders';
} else {
    $paypal_url = 'https://api.paypal.com/v2/checkout/orders';
}

// Assuming you have a valid access token from PayPal
$access_token = 'your_paypal_access_token';

// Get order details from the session or database
$order_id = 1; // Replace with actual order ID

// Calculate total amount from the session or database
$total_amount = 100.00; // Replace with actual total amount

// Create an order with PayPal
$paypal_request_data = [
    'intent' => 'CAPTURE',
    'purchase_units' => [
        [
            'amount' => [
                'currency_code' => 'USD',
                'value' => $total_amount,
            ],
        ],
    ],
];

$paypal_request_headers = [
    'Content-Type: application/json',
    'Authorization: Bearer ' . $access_token,
];

$ch = curl_init($paypal_url);

curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_POST, true);
curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($paypal_request_data));
curl_setopt($ch, CURLOPT_HTTPHEADER, $paypal_request_headers);

$response = curl_exec($ch);
$http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);

curl_close($ch);

if ($http_code == 201) {
    $paypal_response = json_decode($response, true);

    // Store PayPal order ID in the database for reference
    $paypal_order_id = $paypal_response['id'];
    // Save $paypal_order_id in your database for future reference

    // Redirect the user to PayPal for payment
    header('Location: ' . $paypal_response['links'][1]['href']);
    exit();
} else {
    // Handle errors
    echo 'Error creating PayPal order: ' . $response;
}
?>
